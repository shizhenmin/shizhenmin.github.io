---
title: 【饥荒】搭建服务器
categories: 技术
tags: 饥荒
---

* content
{:toc}
## 安装依赖软件

### CentOS系统

```
yum -y install glibc.i686 libstdc++.i686 screen libcurl.i686
```

<br>

另外我在后续安装时遇到问题:

```
error while loading shared libraries: libcurl-gnutls.so.4: cannot open shared object file: No such file or directory
```

用这个命令解决（如果没有遇到问题则不必做）：

```
ln -s /usr/lib/libcurl.so.4.3.0 /usr/lib/libcurl-gnutls.so.4
```

<br>

### Ubuntu系统

```
sudo apt install -y libstdc++6:i386 libgcc1:i386 libcurl4-gnutls-dev:i386 screen
```



## 创建用户

建议新创建一个普通用户，以普通用户的身份运行游戏

```
useradd -m dst  # 创建用户名为 dst 的用户
passwd dst  # 为用户设置密码
su - dst  # 登录
```



## 下载安装steam

```
mkdir ~/steamcmd  
cd ~/steamcmd  
wget https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz
tar -zxvf steamcmd_linux.tar.gz
```



## 上传游戏token和游戏配置

### 获得token

首先获取 token https://accounts.klei.com/account/game/list

将token下载到本地，下载的文件是 `MyDediServer.zip` 这个压缩包，将其解压。

解压后的文件夹中的内容：

```
.
├── Caves
│   └── server.ini
├── cluster.ini
├── cluster_token.txt
└── Master
    └── server.ini
```



### 游戏配置

先在饥荒中创建世界，可以自定义世界和加入mod。进入世界后就可以退出了，这时候游戏的配置就生成好了。配置的位置在：

`C:\Users\用户名\Documents\Klei\DoNotStarveTogether\`

如果刚刚创建的世界是在第五个存档位置，则可以在 `Cluster_5` 中看到这几个文件夹和文件：

```
Caves\
Master\
cluster.ini
cluster_token.txt
```

`Caves` 和 `Master` 这两个文件夹分别对应地上和地下，里面都有 `leveldataoverride.lua` 和 `modoverrides.lua` 这两个文件。将这两个文件复制到 `MyDediServer`，也就是上面的token文件夹。

这时候文件夹中的内容：

```
.
├── Caves
│   ├── leveldataoverride.lua
│   ├── modoverrides.lua
│   └── server.ini
├── cluster.ini
├── cluster_token.txt
└── Master
    ├── leveldataoverride.lua
    ├── modoverrides.lua
    └── server.ini
```



### 将文件夹上传至服务器

首先创建目录

```
mkdir -p ~/.klei/DoNotStarveTogether
```

将token文件夹上传到这个目录里。



## 使用脚本一键安装饥荒专用服务器

```bash
chmod u+x run_dedicated_servers.sh
./run_dedicated_servers.sh
# 当出现Master和Cave等字样，就可以按ctrl+c关闭了
```

<br>

`run_dedicated_servers.sh` 的内容如下：

```bash
#!/bin/bash

steamcmd_dir="$HOME/steamcmd"
install_dir="$HOME/dontstarvetogether_dedicated_server"
cluster_name="MyDediServer"
dontstarve_dir="$HOME/.klei/DoNotStarveTogether"

function fail()
{
	echo Error: "$@" >&2
	exit 1
}

function check_for_file()
{
	if [ ! -e "$1" ]; then
		fail "Missing file: $1"
	fi
}

cd "$steamcmd_dir" || fail "Missing $steamcmd_dir directory!"

check_for_file "steamcmd.sh"
check_for_file "$dontstarve_dir/$cluster_name/cluster.ini"
check_for_file "$dontstarve_dir/$cluster_name/cluster_token.txt"
check_for_file "$dontstarve_dir/$cluster_name/Master/server.ini"
check_for_file "$dontstarve_dir/$cluster_name/Caves/server.ini"

./steamcmd.sh +force_install_dir "$install_dir" +login anonymous +app_update 343050 validate +quit

check_for_file "$install_dir/bin"

cd "$install_dir/bin" || fail

run_shared=(./dontstarve_dedicated_server_nullrenderer)
run_shared+=(-console)
run_shared+=(-cluster "$cluster_name")
run_shared+=(-monitor_parent_process $$)

"${run_shared[@]}" -shard Caves  | sed 's/^/Caves:  /' &
"${run_shared[@]}" -shard Master | sed 's/^/Master: /'
```



## 上传mod文件

将mod文件上传至这个目录：

```
~/dst/dontstarvetogether_dedicated_server/mods
```



## 开启饥荒专用服务器

```bash
screen
./run_dedicated_servers.sh
# 按下ctrl+a，松手后按d，可以回到命令行
```

回到命令行后查看后台进程号

```
screen -ls
```

结果如下：

```
There is a screen on:
        9916.pts-3.aliyun       (Detached)
1 Socket in /var/run/screen/S-dst.
```

`9916` 就是运行饥荒的进程号，如果要返回运行饥荒的界面，可以输入：

```
screen -r 9916
```



## 控制台常用命令

按 `~` (1左边的那个按键) 开启控制台

### 直连服务器

```
c_connect("IP地址",11000,"密码")    #11000是端口号
c_connect("IP地址",11001)    #
```

注意：要选直连服务器，需要开放服务器的对应端口。



### 回档

``` 
c_rollback(2)  #括号内输入你想回档的天数，这里是2
```







