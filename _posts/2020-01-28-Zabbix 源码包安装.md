---
title: zabbix 源码包安装
categories: zabbix
tags: 软件安装
---

* content
{:toc}

本教程中，我们使用的服务器发行版为 `CentOS Linux release 7.7.1908 (Core)`，采用最小化安装。另外，我们假设我们的服务器为内网服务器，不能连接网络，因此需要提前下载Zabbix源码包，并上传至服务器。在安装过程中涉及到的依赖软件，我们可以通过配置镜像文件的yum源来安装，如果软件包不在镜像文件中，则需要下载rpm包，上传至服务器进行手动安装。

使用的Zabbix的版本号为4.4.4，Zabbix数据库使用的是mariadb，前端是LAMP环境。

分别在两台服务器上安装服务端和客户端，服务端的IP地址为 `192.168.11.131`，该服务器同时也作为客户端，对本机进行监控。客户端的IP地址为 `192.168.11.130`。



# 安装服务端

## 1、配置仓库

首先我们通过ISO系统镜像来配置yum源。

在虚拟机中，先连接上ISO镜像文件。连接后，镜像文件所在位置为`/dev/sr0`。挂载镜像：

```bash
#创建挂载点文件夹
mkdir -p /mnt/iso
#将镜像文件挂载到/mnt/iso，这里我们将配置写入/etc/fstab文件，这样开机能够自动挂载
echo /dev/sr0 /mnt/iso iso9660 defaults 0 0 >> /etc/fstab
mount -a  #挂载镜像文件
```



也可以把ISO镜像文件直接上传到服务器上，再挂载ISO文件：

```bash
mount /mnt/CentOS-7-x86_64-DVD-1908.iso /mnt/iso -o loop
#-o loop 用来把一个文件当成硬盘分区挂载到系统上
```



将镜像文件挂载后，就可以配置yum源了。进入 `/etc/yum.repos.d` 目录，删除自带的文件，因为我们的服务器无法联网，所以自带的CentOS源无法使用。或者也可以更改文件的后缀，使其不以 `repo` 结尾，比如在文件名后加上 `.bak`。然后创建一个新的yum源文件。

```bash
cd /etc/yum.repos.d
rm -f *  #删除系统自带的repo文件，也可以给这些文件加上.bak的后缀，使其失效
vi CentOS.repo  #
```

CentOS.repo的内容如下：

> [CentOS]
> name=CentOS
> baseurl=file:///mnt/iso
> enable=1
> gpgcheck=0



## 2、搭建LAMP环境

### 2.1、关闭防火墙

临时关闭：

```bash
systemctl stop firewalld
```

永久关闭：

```bash
systemctl disable firewalld
```



### 2.2、关闭SELinux

临时关闭：

```bash
setenforce 0
```

永久关闭：

```bash
sed -i 's/=enforcing/=permissive/' /etc/selinux/config  #或者改为disabled
```



### 2.3、安装httpd

安装：

```bash
yum -y install httpd
```

启动服务：

```bash
systemctl start httpd  #启动
systemctl enable httpd  #开机启动
systemctl status httpd  #检查服务是否开启
```



### 2.4、安装mariadb

安装：

```bash
yum -y install mariadb mariadb-server mariadb-devel
```

启动服务：

```bash
systemctl start mariadb  #启动
systemctl status mariadb  #开机启动
systemctl enable mariadb  #检查服务是否开启
```



### 2.5、安装PHP环境

安装php：

```bash
yum -y install php php-mysql
```

安装 php-fpm，由于系统镜像不包含此软件，因此需要从 [pkgs.org](https://pkgs.org/download/php-fpm) 下载，上传至服务器上安装。

```bash
yum -y install php-fpm-5.4.16-46.el7.x86_64.rpm
```



修改httpd配置文件`/etc/httpd/conf/httpd.conf`，使httpd服务能够解析php文件。

找到：

> AddType application/x-gzip .gz .tgz

在该行下面添加：

> AddType application/x-httpd-php .php

找到：

> DirectoryIndex index.html

改为：

> DirectoryIndex index.html index.php

可以直接使用下面的命令修改文件：

```bash
sed -i 's/index.html/index.html index.php/' /etc/httpd/conf/httpd.conf
sed -i '/AddType application\/x-gzip .gz .tgz/a\    AddType application\/x-httpd-php .php' /etc/httpd/conf/httpd.conf
```



重启httpd服务

```bash
systemctl restart httpd
```



最后，测试php是否正确解析。

```bash
# vi /var/www/html/test.php

<?php
$i=33;
echo $i;
?>

# curl http://192.168.11.131/test.php
33
```

如果显示的不是源代码，则解析成功。



## 3、安装Zabbix

### 3.1、创建zabbix用户

为Zabbix创建用户，并且创建的是系统用户，且禁止其登录：

```bash
useradd -r -s /sbin/nologin zabbix
```



### 3.2、安装依赖包

```bash
yum -y install gcc net-snmp-devel curl-devel
```

gcc 是源码安装所必需的编译器。

net-snmp-devel 是 `--with-net-snmp` 模块的依赖包。

curl-devel 是 `--with-libcurl` 模块的依赖包。



另外，configure时还需要`libevent-devel`，此软件包不在镜像中，可以从 [libevent-devel](https://pkgs.org/download/libevent-devel) 下载对应版本。

```bash
yum -y install libevent-devel-2.0.21-4.el7.x86_64.rpm
```



### 3.3、源码安装

从[官网](https://www.zabbix.com/download_sources)下载zabbix源码包，上传至服务器，再解压安装。

```bash
tar xzvf zabbix-4.4.4.tar.gz
cd zabbix-4.4.4

./configure --enable-server --enable-agent --with-mysql --with-net-snmp --with-libcurl
make
make install
```

安装时各个选项的含义：

> --enable-server 安装部署zabbix服务器端软件
> --enable-agent  安装部署zabbix被监控端软件
> --with-mysql    配置mysql_config路径
> --with-net-snmp 允许zabbix通过snmp协议监控其他设备
> --with-libcurl  安装相关curl库文件，这样zabbix就可以通过curl连接http等服务，测试被监控主机服务的状态

安装完成后，配置文件在 `/usr/local/etc/` 文件夹中；

程序在 `/usr/local/sbin/` 文件夹中；





### 3.4、配置数据库

首先进入mysql，创建 `zabbix` 数据库，使其支持中文字符集；创建数据库账户 `zabbix`，密码为 `zabbix`：

```bash
# mysql
mysql> create database zabbix character set utf8 collate utf8_bin;
mysql> grant all privileges on zabbix.* to zabbix@localhost identified by 'zabbix';
mysql> quit; 
```

刚刚创建的是空数据库，接着需要导入zabbix源码包自带的数据库配置：

```bash
cd zabbix-4.4.4/database/mysql
mysql -uzabbix -pzabbix zabbix < schema.sql
mysql -uzabbix -pzabbix zabbix < imagessql
mysql -uzabbix -pzabbix zabbix < data.sql
```

==注意：== 导入数据库时，一点要按照上面的顺序，否则会报错！

使用下面的命令检查数据库是否已成功导入：

```bash
mysql -D zabbix -e "show tables;"
```



### 3.5、导入PHP脚本

```bash
cd zabbix-4.4.4/frontends/
cp -r php/ /var/www/html/zabbix
chown -R apache:apache /var/www/html/zabbix
```



### 3.6、修改Zabbix配置文件

服务端需要修改 `/usr/local/etc/zabbix_server.conf` 文件中的数据库主机名与密码：

```bash
sed -i 's/^# DBHost/DBHost/' /usr/local/etc/zabbix_server.conf
sed -i 's/^# DBPassword=/DBPassword=zabbix/' /usr/local/etc/zabbix_server.conf
```

修改后配置如下：

> LogFile=/tmp/zabbix_server.log    #存放 zabbix server 日志文件的位置
> DBHost=localhost                  #zabbix server 数据库的位置
> DBName=zabbix                     #数据库名
> DBUser=zabbix                     #数据库用户名
> DBPassword=zabbix                 #数据库密码
> Timeout=4                         #等待 agent、SNMP 设备或自定义脚本的执行时间
> LogSlowQueries=3000               #
> StatsAllowedIP=127.0.0.1          #



客户端需要修改 `/usr/local/etc/zabbix_agentd.conf` 文件中：

```bash
sed -i 's/^Hostname=.*/Hostname=zabbix_server/' /usr/local/etc/zabbix_agentd.conf
sed -i 's/# UnsafeUserParameters=0/UnsafeUserParameters=1/' /usr/local/etc/zabbix_agentd.conf
```

修改后配置如下：

> LogFile=/tmp/zabbix_agentd.log    #存放 zabbix agent 日志文件的位置
> Server=127.0.0.1                  #server 的 IP 或主机名
> ServerActive=127.0.0.1            #用于主动检查的 IP （或者主机名）和端口
> Hostname=zabbix_server            #zabbix agent 的主机名
> UnsafeUserParameters=1            #



### 3.7、启动服务

```bash
zabbix_server
zabbix_agentd
```

==注意：== 如果是因为配置文件不对，导致服务无法启动时，一定要先使用 `killall zabbix_server` 或 `killall zabbix_agentd` 关闭服务后，再重新启动一次。



### 3.8、拷贝启动脚本（可选）

拷贝启动脚本（非必须操作，可选做），有启动脚本可以方便管理服务，启动与关闭服务。启动脚本位于zabbix源码目录下。

```bash
cd zabbix-4.4.4/misc/init.d/fedora/core/
cp * /etc/init.d/
```

共有两个启动脚本：`zabbix_agentd` 和 `zabbix_server`，可以通过以下方式管理服务：
```
Usage: /etc/init.d/zabbix_server {start|stop|status|restart|help}
Usage: /etc/init.d/zabbix_agentd {start|stop|status|restart|help}
```


### 3.9、修改PHP参数

此时在浏览器中输入 `192.168.11.131/zabbix` 访问zabbix前端，在 Check of pre-requisites 这一步中会显示一些项目检测不通过，根据错误提示，修改PHP配置文件中的参数。

```bash
sed -i 's/post_max_size = 8M/post_max_size = 16M/' /etc/php.ini
sed -i 's/max_execution_time = 30/max_execution_time = 300/' /etc/php.ini
sed -i 's/max_input_time = 60/max_input_time = 300/' /etc/php.ini
sed -i 's/;date.timezone =/date.timezone = Asia\/Shanghai/' /etc/php.ini
```

重启httpd:

```bash
systemctl restart httpd
```



### 3.10、安装依赖软件

zabbix需要额外的一些php软件来完成绘制图形等工作，需要安装 php-gd，php-xml，[php-bcmath](https://pkgs.org/download/php-bcmath)，[php-mbstring](https://pkgs.org/download/php-mbstring)

```bash
yum -y install php-gd php-xml
yum -y install php-bcmath-5.4.16-46.el7.x86_64.rpm
yum -y install php-mbstring-5.4.16-46.el7.x86_64.rpm
```

重启httpd:

```bash
systemctl restart httpd
```



### 3.11、配置前端网页

经过上面的步骤，此时在 Check of pre-requisites 中，除了 `PHP LDAP` 显示为 Warning 外，各个项目都显示为 OK，即可进行下一步配置。

![Zabbix_Install_web_01](/images/Zabbix_Install_web_02.png)

![Zabbix_Install_web_01](/images/Zabbix_Install_web_03.png)

![Zabbix_Install_web_01](/images/Zabbix_Install_web_04.png)

![Zabbix_Install_web_01](/images/Zabbix_Install_web_05.png)

![Zabbix_Install_web_01](/images/Zabbix_Install_web_06.png)

![Zabbix_Install_web_01](/images/Zabbix_Install_web_07.png)

### 3.12、解决中文乱码问题（可选）

点击web右上角的小人图标，可以修改网页使用的语言。但修改为简体中文后，会出现一些乱码，这是由于web自带的字体不兼容所导致的。解决的方法是从windows中拷贝字体到web前端的fonts目录下，并修改字体配置。下面以微软雅黑 `msyh.ttf` 为例进行修改。

```bash
cp /tmp/mysh.ttc /var/www/html/zabbix/assets/fonts
#搜索 FONT_NAME，把字体改为 msyh
sed -i s'/DejaVuSans/msyh/' /var/www/html/zabbix/include/defines.inc.php
```





# 安装服务端

## 1、配置仓库

需要配置 Zabbix 镜像仓库，具体见服务端安装的部分。



## 2、安装依赖包

```bash
yum -y install gcc pcre-devel
```



## 3、创建zabbix用户

为Zabbix创建用户，并且创建的是系统用户，且禁止其登录：

```bash
useradd -r -s /sbin/nologin zabbix
```



## 4、源码安装

从[官网](https://www.zabbix.com/download_sources)下载zabbix源码包，上传至服务器，再解压安装。

```bash
tar xzvf zabbix-4.4.4.tar.gz
cd zabbix-4.4.4

./configure --enable-agent
make
make install
```



安装完成后，配置文件在 `/usr/local/etc/` 文件夹中；

程序在 `/usr/local/sbin/` 文件夹中；



## 5、修改配置文件

客户端需要修改 `/usr/local/etc/zabbix_agentd.conf` 文件中：

```bash
cd /usr/local/etc/
sed -i 's/^Server=127.0.0.1/Server=192.168.11.131/' zabbix_agentd.conf
sed -i 's/^ServerActive=127.0.0.1/ServerActive=192.168.11.131/' zabbix_agentd.conf
sed -i 's/^Hostname=.*/Hostname=zabbix_agent1/' zabbix_agentd.conf
sed -i 's/# EnableRemoteCommands=0/EnableRemoteCommands=1/' zabbix_agentd.conf
sed -i 's/# UnsafeUserParameters=0/UnsafeUserParameters=1/' zabbix_agentd.conf
```

修改后配置如下：

> LogFile=/tmp/zabbix_agentd.log  #日志文件
> EnableRemoteCommands=1       #允许服务器远程执行命令
> Server=192.168.11.131        #被动监控模式
> ServerActive=192.168.11.131  #主动监控模式
> Hostname=zabbix_agent1       #客户端主机名
> UnsafeUserParameters=1       #允许自定义key监控



## 6、关闭防火墙

```bash
systemctl stop firewalld
```



## 7、启动客户端

```bash
zabbix_agentd
```



## 8、拷贝启动脚本

拷贝启动脚本（非必须操作，可选做），有启动脚本可以方便管理服务，启动与关闭服务。启动脚本位于zabbix源码目录下。

```bash
cd zabbix-4.4.4/misc/init.d/fedora/core/
cp zabbix_agentd /etc/init.d/
```

将启动脚本 `zabbix_agentd` 复制到系统目录下，可以通过以下方式管理服务：

> Usage: /etc/init.d/zabbix_agentd {start|stop|status|restart|help}



## 9、服务端监控客户端

客户端安装完成后，需要在web前端添加对客户端的监控。

在 Configuration -> Host 中点击右上角的 Create host 添加需要被监控的主机。

![Zabbix_Install_web_01](/images/Zabbix_Create_host_01.png)

在 Host 这个页面中填写 Host name (需要与客户端zabbix_agentd.conf中的 Hostname 一致)，Groups (点击右边的 Select，随意选择一个Group)，IP address (客户端IP地址)。之后点击左上角 Templates，添加需要关联的监控模板。

![Zabbix_Install_web_01](/images/Zabbix_Create_host_02.png)













