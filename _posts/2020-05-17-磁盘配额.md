---
title: 设置磁盘配额
categories: Linux
tags: 教程 Linux 磁盘配额
---

* content
{:toc}
## 磁盘配额概述

1. 作用：限制用户对磁盘空间的使用量。

2. 作用范围：只在指定的分区有效。

3. 限制对象：主要针对用户、组进行限制，对组账号限制，组内所有用户的使用总和不能超过限制。

4. 限制类型：磁盘容量限制（Block），默认单位KB、文件数量限制（Inode）。

5. 限制方法：软限制、硬限制。软限制默认7天内允许超过，会有警告。硬限制不允许超过，硬限制应当比软限制大，否者软限制失效。



## EXT4文件系统

### 1. 安装quota工具

CentOS 系统：

```bash
yum -y install quota
```

Ubuntu 系统：

```bash
apt-get install quota
```



### 2. quota相关命令介绍

#### quotacheck

检测磁盘配额并生成配额文件

- `-a`：检测所有可用的分区

- `-u`：检测用户配额

- `-g`：检测组配额

- `-c`：创建配额数据文件

- `-v`：显示执行过程

```bash
quotacheck -ugcv 设备文件名
quotacheck -augcv
```



####  edquota

编辑用户和组账号的配额设置

- `-u`：修改用户配额，默认KB。

- `-g`：修改组配额，默认KB。

- `-t`：修改宽限时间

- `-p 用户名/组名`：以该用户/组为原型，将配额配置复制给其他用户

```bash
edquota -u 用户名
edquota -g 组名
edquota -t  #修改宽限时间
edquota -p user1 user2 user3  #将user1的配额配置复制给user2和user3
```



#### quotaon & quotaoff

启动或关闭文件系统的磁盘配额功能

- `-u`：用户名

- `-g`：用户组

- `-v`：显示过程

- `-p`：显示配额的开启和关闭

```bash
quotaon -ugv 设备文件名或挂载点
quotaoff -ugv 设备文件名或挂载点
quotaon -pa  #显示所有文件系统的开闭
```



#### quota

查看用户、组配额使用情况

- `-u`：用户名

- `-g`：用户组


```bash
quota -u 用户名
quota -g 组名
```



#### repquota

查看分区磁盘配额使用情况

- `-a`：检测所有可用的分区

- `-u`：检测用户配额

- `-g`：检测组配额

```bash
repquota -aug
repquota 挂载点
```



#### setquota

```bash
setquota -u user1 400G 500G 100 200 /dev/sdb1
```



### 3. EXT4磁盘配额设置

#### 1. 查看待配置的设备

为 `/home` 目录的磁盘开启磁盘配额，查看该目录的文件系统：

```plaintext
root@workdstation:~# df -h | grep home
/dev/mapper/lvm--home-lv--0   11T  182G   11T   2% /home
root@workdstation:~# blkid /dev/mapper/lvm--home-lv--0 
/dev/mapper/lvm--home-lv--0: UUID="090cca08-c328-48bc-b2ab-7191f40e6fc3" TYPE="ext4"
```

逻辑卷 `/dev/mapper/lvm--home-lv--0` 是 `/home` 目录的设备。

查看该设备的挂载参数：

```plaintext
root@workdstation:~# mount | grep /dev/mapper/lvm--home-lv--0 
/dev/mapper/lvm--home-lv--0 on /home type ext4 (rw,relatime,data=ordered)
```



#### 2. 开启磁盘配额支持

修改 `/etc/fstab` 文件，使配置永久生效。在 `defaults` 后面加上 `,usrquota,grpquota` ：

```plaintext
root@workdstation:~# vim /etc/fstab
UUID=090cca08-c328-48bc-b2ab-7191f40e6fc3 /home ext4 defaults,usrquota,grpquota 0 0
```



重新挂载设备：

```bash
umount /home
mount -a
```



再次查看该设备的挂载参数，可以看到参数已经生效：

```Plaintext
root@workdstation:~# mount | grep /dev/mapper/lvm--home-lv--0  
/dev/mapper/lvm--home-lv--0 on /home type ext4 (rw,relatime,quota,usrquota,grpquota,data=ordered)
```



#### 3. 生成配额配置文件

使用 `quotacheck` 命令检测磁盘配额并生成配额文件：

```bash
quotacheck -ugcv /home/
```

执行上面的命令后，就会在 `/home` 目录中生成 `aquota.group` 和 `aquota.user` 这两个文件，这两个文件是二进制文件，无法直接查看。



#### 4. 修改用户配额设置

配置文件内容如下：

```plaintext
Disk quotas for user quota_test (uid 1001):
Filesystem       blocks      soft       hard     inodes     soft     hard
/dev/sdb1         0           0          0         0         0         0
```

- 第一行展示要设置磁盘配额的用户的信息。

- `block`：该用户在该设备下现有文件总大小，系统会自动计算，单位为KB

- `inodes`：该用户在该设备下现有文件总数量，系统会自动计算

- `soft`：设置的警告值，当磁盘使用量在 soft-hard 之间，就会发出警告（默认倒计时7天），若超过警告时间，磁盘使用量依然在 soft-hard 之间，则会禁止使用磁盘空间

- `hard`：设置的最大值，若达到最大值，则会直接禁止使用磁盘空间

修改磁盘配额设置：

```plaintext
[root@localhost ~]# edquota -u shizhenmin
Disk quotas for user shizhenmin (uid 1001):
  Filesystem                   blocks       soft       hard     inodes     soft     hard
  /dev/mapper/lvm--home-lv--0    2665036    2800000    3000000        747      751        753
```

该用户现有占用磁盘空间 2.6G，将 soft 值和 hard 值分别设为 2.8G 和 3.0G；已有文件 747个，将 soft 值和 hard 值分别设为 751 和 753G



#### 5. 启用磁盘配额功能

```bash
quotaon -ugv /home/
```

若要关闭，使用 `quotaoff` 命令。



#### 6. 磁盘空间配额测试

```plaintext
~ $ dd if=/dev/zero of=/home/shizhenmin/test1.txt bs=1M count=500
dd: error writing '/home/shizhenmin/test1.txt': Disk quota exceeded
```



#### 7. 文件数量配额测试

```plaintext
~ $ touch file{1..6}.txt
touch: cannot touch 'file6.txt': Disk quota exceeded
```



#### 8. 查看用户配额使用情况

```plaintext
root@workdstation:/home# quota -u shizhenmin
Disk quotas for user shizhenmin (uid 1001): 
     Filesystem  blocks   quota   limit   grace   files   quota   limit   grace
/dev/mapper/lvm--home-lv--0
                3000000* 2800000 3000000   6days     753*    751     753   6days
```







参考网站：

[Linux 磁盘配额（XFS & EXT4）](https://www.cnblogs.com/llife/p/11406819.html)

[linux之磁盘配额(quota)](https://www.cnblogs.com/xwhoami/p/5801080.html)

[管理磁盘配额](https://www.ibm.com/developerworks/cn/linux/l-lpic1-v3-104-4/index.html)





